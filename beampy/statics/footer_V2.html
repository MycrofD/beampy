<script>
  //Beampy script is inspired by DzSlides javascript code (https://github.com/paulrouget/dzslides)
  
  var Beampy = {
    id_slide: -1,
    html: null,
    slides: null,
    params: {}
  };

  Beampy.init = function() {
    document.body.className = "loaded";
    this.slides = Object.keys(slides); <!-- load slides from json -->
    this.html = document.body.parentNode;
    //Load slides in store
    this.load_store();
    this.setup();
    this.onhashchange();
    this.setupTouchEvents();
    this.onresize();
    this.initmouse();

  }

  Beampy.load_store = function() {

     $('#msg').html('<progress id="pbar" max="'+(this.slides.length-1)+'" value="0" style="border: none; height: 8px; width: 100%; 	position:fixed; top:0;"></progress>');
     $('#msg').css('width', '100%');
     var pbar = $('#pbar');
     var i=0;
     var pTimer = setTimeout(update, 0, this, pbar);

     function update(s, pbar){
  	if (i < s.slides.length){
	    $('#store_'+s.slides[i]).html("<svg><defs><g id='"+s.slides[i]+"'>"+store[s.slides[i]]['svg']+"</g></defs></svg>" );

  	    //check if we need to had html
            if( store[s.slides[i]].hasOwnProperty('html') ){
  	    	$('#store_'+s.slides[i]).append('<div id="html_store_'+s.slides[i]+'">'+store[s.slides[i]].html+'</div>');
  	    }

  	    //check if we need to had svg animation
  	    //if(store[s.slides[i]].hasOwnProperty('animations')]){
		//TODO: Load cached images

  	    //}
  	    pbar.val(i);
  	    //delete the content from the store (for memory)
  	    delete store[s.slides[i]];

            //console.log(i);
  	    i++;
  	    var pTimer = setTimeout(update, 0, s, pbar);
     	} else {

  	//console.log('End of loading store clean timer');
     	clearTimeout(pTimer);
  	$('#msg').html('');
  	delete store;
  	Beampy.toggleContent();
  	}
     }


  }

  Beampy.setup = function() {
    var p = window.location.search.substr(1).split('&');
    p.forEach(function(e, i, a) {
      var keyVal = e.split('=');
      Beampy.params[keyVal[0]] = decodeURIComponent(keyVal[1]);
    });
  }


  Beampy.onkeydown = function(aEvent) {
    // Don't intercept keyboard shortcuts
    if (aEvent.altKey
      || aEvent.ctrlKey
      || aEvent.metaKey
      || aEvent.shiftKey) {
      return;
    }
    if ( aEvent.keyCode == 37 // left arrow
      || aEvent.keyCode == 38 // up arrow
      || aEvent.keyCode == 33 // page up
    ) {
      aEvent.preventDefault();
      this.back();
    }
    if ( aEvent.keyCode == 39 // right arrow
      || aEvent.keyCode == 40 // down arrow
      || aEvent.keyCode == 34 // page down
    ) {
      aEvent.preventDefault();
      this.forward();
    }
    if (aEvent.keyCode == 35) { // end
      aEvent.preventDefault();
      this.goEnd();
    }
    if (aEvent.keyCode == 36) { // home
      aEvent.preventDefault();
      this.goStart();
    }
    if (aEvent.keyCode == 32) { // space
      aEvent.preventDefault();
      $("#html_store_slide_"+this.id_slide+" video").each(function(){
	    if (this.paused || this.ended){
  	        this.play();
  	    } else {
  	        this.pause();
  	    }


      });
    }
    if (aEvent.keyCode == 70) { // f
      aEvent.preventDefault();
      this.goFullscreen();
    }
  }

  /* Mouse scroll event */
  Beampy.onmousewheel = function(event) {
  
    //Test if their is a bokeh figure to prevent conflict
    var bokeh = $('.plotdiv');
    if (bokeh.length == 0) {
        event.preventDefault();
        //console.log(event);
        //Compute +1 for up and -1 for down
        var delta = Math.max(-1, Math.min(1, (event.wheelDelta || -event.detail)));
        
        if (delta == -1){
            this.forward();
        }
        
        if (delta == 1){
            this.back();
        } 
        
        return false;
     }
  }
  /* Touch Events */

  Beampy.setupTouchEvents = function() {
    var orgX, newX;
    var tracking = false;

    var db = document.body;
    db.addEventListener("touchstart", start.bind(this), false);
    db.addEventListener("touchmove", move.bind(this), false);

    function start(aEvent) {
      aEvent.preventDefault();
      tracking = true;
      orgX = aEvent.changedTouches[0].pageX;
    }

    function move(aEvent) {
      if (!tracking) return;
      newX = aEvent.changedTouches[0].pageX;
      if (orgX - newX > 100) {
        tracking = false;
        this.forward();
      } else {
        if (orgX - newX < -100) {
          tracking = false;
          this.back();
        }
      }
    }
  }

  /* Adapt the size of the slides to the window */

  Beampy.onresize = function() {
    var db = document.body;
    var sx = db.clientWidth / window.innerWidth;
    var sy = db.clientHeight / window.innerHeight;
    var transform = "scale(" + (1/Math.max(sx, sy)) + ")";

    db.style.MozTransform = transform;
    db.style.WebkitTransform = transform;
    db.style.OTransform = transform;
    db.style.msTransform = transform;
    db.style.transform = transform;
  }


  Beampy.toggleContent = function() {
    //get the video in the store for the current id_slide
    var videos = $("#html_store_slide_"+this.id_slide+" video");

    //if they are visible hidde them and reset their content to 0
    if (videos.css('visibility') == 'visible'){
        videos.css('visibility', 'hidden');
        videos.each(function(){
	    //reset the video to position 0 in time
            this.pause();
            this.currentTime = 0;
        });
    } else {
    	videos.css('visibility', 'visible');
        videos.focus();
    }

    //get the div in html_store_slide to set their visibility
    var divs = $("#html_store_slide_"+this.id_slide+" div");
    if (divs.css('visibility') == 'visible'){
        divs.css('visibility', 'hidden');
    } else {
        divs.css('visibility', 'visible');
    }
  }

 Beampy.animatesvg = function(anim_number, fps, number_of_frames){
    //Count can be donne via javascript maingroup.childElementCount - 1
    var frameCount = number_of_frames;
    var anim_number = anim_number;
    //Reset frame view NO JQUERY FOR SVG !!!
    var maingroup = document.getElementById('svganimate_s'+this.id_slide+'_'+anim_number);
    var curslide = slides['slide_'+this.id_slide];
    var i = 1;
    var frames = maingroup.childNodes;
    //reset frames to none
    //for (j = 0; j<frameCount; j++){
//	console.log(j);
//    	frames[j].style['visibility'] = 'hidden';
//    }

    var display_frames = function(){
        //console.log(i)

        if( curslide.hasOwnProperty('svganimates') ){
      	    maingroup.innerHTML = curslide['svganimates'][anim_number]['frames'][i] ;
      	}

        //maingroup.innerHTML = '<use xlink:href="#frame_'+i+'" x="0" y="0"/>'
        //maingroup.setAttributeNS('http://www.w3.org/2000/svg', 'xlink:href','#frame_'+i)
        i++;
        
        if (i == frameCount){
            //console.log("test stop");
            clearInterval(intervalometer);        
        }
    }
    
    
    var intervalometer = setInterval(function () { 
        display_frames();
    }, 1000*1/fps);
  }
  
  Beampy.setCursor = function(aIdx) {
    // If the user change the slide number in the URL bar, jump
    // to this slide.
    window.location.hash = "#" + aIdx ;
  }

  Beampy.onhashchange = function() {
    var cursor = window.location.hash.split("#"),
        newidx = 0,
        newstep = 0;
    if (cursor.length == 2) {
      newidx = ~~cursor[1]
    }

    if (newidx != this.id_slide) {
      this.setSlide(newidx);
    }
  }

  Beampy.back = function() {
    if (this.id_slide == 0) {
      return;
    }else {
      this.setCursor(this.id_slide-1);
    }
  }

  Beampy.forward = function() {
    if (this.id_slide >= this.slides.length-1 ) {
        return;
    }
    else {
      this.setCursor(this.id_slide + 1);
    }
  }

  Beampy.goStart = function() {
    this.setCursor(0);
  }

  Beampy.goEnd = function() {
    var lastIdx = this.slides.length - 1;
    this.setCursor(lastIdx);
  }


  Beampy.setSlide = function(aIdx) {

    //Deselect the previous store
    Beampy.toggleContent();
    //$("#store_slide_"+this.id_slide).attr('selected', false);
    this.id_slide = aIdx;

    if (aIdx <= this.slides.length - 1) {
    
      var curslide = slides['slide_'+aIdx];
      
      
      //check if we need to had html
      //if( curslide.hasOwnProperty('htmlcontent') ){
      //  $("section").html( curslide.svg + curslide.htmlcontent );
      //} else {
        //Only render svg
        $("section").html( curslide.svg );
        Beampy.toggleContent();
       //set the store as selected
       //$("#store_slide_"+this.id_slide).attr('selected', true);
      //}


      //var video = $("video");
      //old stange !!+before this.params.autoplay
      //if (video.length && this.params.autoplay) {
      //  video.play();
      //}



    //Pour bokeh
    var bokeh = $('.plotdiv');
    if (bokeh.length) {
        scripts_slide['slide_'+Beampy.id_slide].load_bokeh();
    }

    //Test si des residus de bokeh
    var bokeh_trash = $('.bk-bs-modal');
    if (bokeh_trash.length) {
        bokeh_trash.remove(); //Remove these remainings divs
    }

    } else {
      // That should not happen
      this.id_slide = -1;
      // console.warn("Slide doesn't exist.");
    }
  }


  Beampy.goFullscreen = function() {
    var html = document.documentElement,
   requestFullscreen = html.requestFullscreen || html.requestFullScreen || html.mozRequestFullScreen || html.webkitRequestFullScreen;
    if (requestFullscreen) {
      requestFullscreen.apply(html);
    }
  }
  
  //Function to hide the mouse when it is idle taken from https://gist.github.com/josephwegner/1228975
  Beampy.initmouse = function() {  
        var idleMouseTimer;
        var forceMouseHide = false;

        $("html").css('cursor', 'none');

        $("html").mousemove(function(ev) {
            if(!forceMouseHide) {
                $("html").css('cursor', '');

                clearTimeout(idleMouseTimer);

                idleMouseTimer = setTimeout(function() {
                    $("html").css('cursor', 'none');

                    forceMouseHide = true;
                    setTimeout(function() {
                        forceMouseHide = false;
                        }, 200);
                    }, 500);
            }
        }); 
    }
  
  function init() {
    Beampy.init();
    window.onkeydown = Beampy.onkeydown.bind(Beampy);
    window.onresize = Beampy.onresize.bind(Beampy);
    window.onhashchange = Beampy.onhashchange.bind(Beampy);
    //For chrome, safari, ie, opera
    window.onmousewheel = Beampy.onmousewheel.bind(Beampy);
    //For firefox
    window.addEventListener("DOMMouseScroll", Beampy.onmousewheel.bind(Beampy), false);
  }

  window.onload = init;
</script>

